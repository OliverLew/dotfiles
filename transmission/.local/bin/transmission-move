#!/bin/sh

# username, password, etc for transmission-remote
remote_args=""

while getopts "hinrtl" arg; do
    case "$arg" in
        i) i_flag=1;;
        n) n_flag=1;;
        r) r_flag=1;;
        t) t_flag=1;;
        l) l_flag=1;;
        h)
            printf "Usage: %s [-inrtl] \"match pattern\"\n" "$(basename "$0")"
            printf "\t-i: print id\n"
            printf "\t-n: print name\n"
            printf "\t-r: print resume file path\n"
            printf "\t-t: print torrent file path\n"
            printf "\t-l: print download dir path\n"
            exit
            ;;
        *) ;;
    esac
done
shift $((OPTIND - 1))
match=$1

config_dir=$(transmission-remote $remote_args -si |
             awk -F ": " '/Configuration directory:/{ print $2 }')
torrent_dir="$config_dir"/torrents
resume_dir="$config_dir"/resume

for i in $(transmission-remote $remote_args -l | grep -o "^[[:space:]]*[[:digit:]]*")
do
    info=$(transmission-remote $remote_args -t"$i" -i)
    if echo "$info" | grep -E "$match" > /dev/null
    then
        name=$(echo "$info" | awk -F ": " '/Name:/{ print $2 }')
        info_hash=$(echo "$info" | awk -F ": " '/Hash:/{ print substr($2, 1, 16) }')
        location=$(echo "$info" | awk -F ": " '/Location:/{ print $2 }')

        resume_file=$(find "$resume_dir" -name "*.$info_hash.resume")
        torrent_file=$(find "$torrent_dir" -name "*.$info_hash.torrent")

        if [ -f "$resume_file" ] && [ -f "$torrent_file" ]
        then
            [ -n "$i_flag" ] && echo "$i"
            [ -n "$n_flag" ] && echo "$name"
            [ -n "$r_flag" ] && echo "$resume_file"
            [ -n "$t_flag" ] && echo "$torrent_file"
            [ -n "$l_flag" ] && echo "$location"
        else
            echo Torrent or resume file not file for ID: "$i", "$name"
        fi
    fi
done

#!/bin/bash

# find the user on X (display)
# https://unix.stackexchange.com/a/204498
while read -r id _ user _; do
    while IFS='=' read -r property value; do
        case "$property" in
        Active)
            if [[ "$value" != "yes" ]]; then continue; fi
            ;;
        Display)
            if [[ "$value" ]]; then CUR_USER="$user"; CUR_DISPLAY="$value"; fi
            # else the session isn't graphical
            ;;
        esac
    done < <(loginctl show-session -p Display -p Active "$id")
done < <(loginctl list-sessions --no-legend)

DISPLAY="$CUR_DISPLAY" sudo -u "$CUR_USER" /usr/bin/xmodmap -e 'clear Lock' -e 'keycode 0x42 = Escape Caps_Lock'

#!/bin/sh

FIFO="/tmp/udev-local.fifo"
UDEV_LOCAL_LOG="/tmp/udev-local.log"

if [ $# -ge 1 ]; then
    echo "$*" > $FIFO
    echo "sending: $*" >> $UDEV_LOCAL_LOG
    exit
fi

if [ ! -p $FIFO ]; then
    rm -f $FIFO && mkfifo $FIFO || exit 1
fi

while true; do
    while read -r t p; do
        echo "debug: $t" >> $UDEV_LOCAL_LOG
        case "$t" in
            capslock)
                notify-send "New keyboard" "Mapping CapsLock -> Escape."
                sleep 1 # xmodmap won't work on new keyboards without this delay
                DISPLAY=:0 /usr/bin/xmodmap -e 'clear Lock' -e 'keycode 0x42 = Escape Caps_Lock'
                ;;
            ac)
                [ "$p" = 1 ] && notify-send "Power supply" "AC adpater pluged in"
                [ "$p" = 0 ] && notify-send "Power supply" "AC adpater unpluged"
                ;;
            drm)
                notify-send "External monitor detected"
                sh -c "$(which setmonitor)"
                ;;
            *)
                ;;
        esac
    done < $FIFO
done

rm $FIFO

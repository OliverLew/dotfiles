#!/bin/sh
#
# Wrapping script around irssi featuring:
# 1. Run irssi in a tmux session to work with some irssi scripts, e.g.
#     - adv_windowlist.pl
#     - tmux-nicklist-portable.pl
# 2. Use tmux detach functionality (but nothing else like keybindings, etc.)
# 3. Export irc passwords using 'pass' through shell environments that can be
#    used in irssi config
#
# Note:
# a. The passwords stored with 'pass' command should be under a 'irc' subfolder
#    and have the file structure as:
#      irc
#      └── network
#          └── nickname
#    You can create it with `pass insert irc/network/nickname`
#    The exported shell variable are named $pass_network_nickname
# b. The script even starts tmux inside another tmux session by unset the $TMUX
#    shell environment. The side effect is tried to be minimized by unbinding
#    all tmux keybindings and hiding the status bar in the nested session so
#    that the outter tmux works like the nested session never exists.
#    (It can still be hacked by '/exec tmux' command in irssi)

# Pass the passwords as shell environments into irssi
for network in "$HOME"/.password-store/irc/*
do
    for nickname in "$network"/*
    do
        net=$(basename "$network")
        nick=$(basename "${nickname%.*}")
        passvar=pass_"$net"_"$nick"
        eval "$passvar=$(pass show irc/"$net"/"$nick")"
        eval export "$passvar"
    done
done

# start in tmux
irssi_tmux()
{
    if ! tmux -L irssi ls -F "#S" 2> /dev/null | grep -q irssi
    then
        tmux -L irssi -f /dev/null new -d -s irssi /usr/bin/irssi
        # disable all keybindings, let the irssi script deal with tmux
        tmux -L irssi unbind-key -a
        tmux -L irssi set -g prefix None
        # leave a detach short cut, this is the same as abduco
        tmux -L irssi bind-key -n C-\\ detach-client
        # hide status bar
        tmux -L irssi set-option status off
    fi
    tmux -L irssi attach -t irssi
}

# unset $TMUX if already in tmux
if [ -n "$TMUX" ]; then
    export TMUX_TEMP="$TMUX"
    unset TMUX
    irssi_tmux
    export TMUX="$TMUX_TEMP"
    unset TMUX_TEMP
else
    irssi_tmux
fi

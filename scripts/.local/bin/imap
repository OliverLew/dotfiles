#!/bin/sh

# Get the server and port if provided
while getopts s:p: param
do
    case "$param" in
        s)
            server="$OPTARG"
            ;;
        p)
            port="$OPTARG"
            ;;
        ?)
            ;;
    esac
done
shift $((OPTIND - 1))

# Get the email
if [ $# = 1 ]
then
    email=$1
else
    echo Only one positional argument as email
    exit
fi

case "${email#*@}" in
    outlook.com)
        server=imap-mail.outlook.com
        port=993
        ;;
    qq.com)
        server=imap.qq.com
        port=993
        ;;
    gmail)
        server=imap.gmail.com
        port=993
        ;;
    ?)
        ;;
esac

password=$(pass show mail/"$email")

if [ -z "$server" ] || [ -z "$port" ] || [ -z "$password" ]
then
    echo Error
    exit
fi

if ! curl -fsm 10 --connect-timeout 10 \
          --url "imaps://$server:$port" \
          --user "$email:$password" \
          --request "STATUS Inbox (UNSEEN)" | grep -oE "[0-9]*"
then
    echo Timeout
fi

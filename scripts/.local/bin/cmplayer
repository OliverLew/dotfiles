#!/bin/sh
# A script to play video in framebuffer using mplayer and put it on the position
# of current tmux pane if in a tmux session.
# Environment:
#   framebuffer, e.g. in tty or fbterm
# Requirement:
#   mplayer
#   ffprobe (part of ffmpeg, should be installed if you have mplayer)
#   tmux or fbset (at least one)

# Note: you might need to modify this according to your vconsole font setting
# or the terminal emulator you are using, e.g. fbterm.
# Character width and height
charw=10
charh=20

usage="usage: $(basename "$0") video [video ...]"

if [ $# = 0 ]
then
    echo "$usage"
    exit
fi

# Deal with some exit signals (still can't process KILL signal, good luck with that)
trap 'clear; tput cnorm' INT TERM
trap 'tput cnorm' QUIT EXIT

# Calculate position and available size
if tmux display -p -F "#S" > /dev/null 2>&1
then
    pane_id=$(tmux display -p -F "#D" | tr -d %)
    # The following command does the steps:
    # 1. Output the layout of all the panes
    # 2. Locate the current pane by its pane id
    # 3. Get the pane's location and size (in unit of characters)
    #
    # The format is loosely summarised as:
    # <format> = <width>x<height>,<x>,<y>,(<id> or {<format>} or [<format>])
    #
    # We only need the ones with ids, which means they don't have child structures.
    read -r w h x y << EOF
    $(tmux display -p -F "#{window_visible_layout}" | \
    grep -oE "[0-9]+x[0-9]+,[0-9]+,[0-9]+,[0-9]+" | \
    awk -F'[x,]' '{ if($5 == '"$pane_id"') print $1, $2, $3, $4 }')
EOF
    W=$((w * charw))
    H=$((h * charh))
    X=$((x * charw))
    Y=$((y * charh))
else
    # Use framebuffer size if not in tmux
    X=0
    Y=0
    read -r W H << EOF
    $(fbset | awk '/geometry/{ print $2, $3 }')
EOF
fi

# Play each of the videos separately (deal with different video sizes)
for video in "$@"
do
    # Get the real size of the video
    read -r width height sar_x sar_y << EOF
    $(ffprobe "$video" \
              -v error \
              -select_streams v:0 \
              -show_entries stream=width,height,sample_aspect_ratio \
              -of csv=s=x:p=0 |
    awk -F'[x:]' '{ print $1, $2, $3, $4 }')
EOF

    # Calculate the actual video dimension on screen that could fit in the pane
    vH="$H"
    vW="$W"
    if [ $((width * H - height * W)) -gt 0 ]
    then
        vH=$((height * W / width))
    else
        vW=$((width * H / height))
    fi

    # fix the aspect ratio, sar might be absent in some videos
    if [ "$sar_x" != "N/A" ] && [ -n "$sar_x" ] || [ -n "$sar_y" ]
    then
        vW=$((vW * sar_x / sar_y))
    fi

    # Hide the cursor in case it blinks in the video region
    tput civis
    # Play the video
    clear
    mplayer "$video" -msglevel all=-1 -nolirc \
            -vo fbdev2 \
            -vf scale=$vW:$vH \
            -geometry $X:$Y || exit 1
    clear
    # Show the cursor
    tput cnorm
done

#!/bin/sh

tmpfile="/tmp/tmux_cpu_info"

if [ ! -f "$tmpfile" ] || [ "$(stat -c "%U" "$tmpfile")" != "$USER" ]; then
    echo "err"
    exit
elif [ "$(stat -c "%a" "$tmpfile")" != "600" ]; then
    chmod 600 "$tmpfile"
fi

total=0
active=0
count=0
for i in $(grep "cpu " /proc/stat | tr -d cpu)
do
    total=$((total + i))
    count=$((count + 1))
    if [ "$count" -lt 4 ] || [ "$count" -gt 5 ]
    then
        active=$((active + i))
    fi
done

if [ -f "$tmpfile" ]; then
    read -r active_old total_old < "$tmpfile"
    printf "%02s" $(((active - active_old) * 100 / (total - total_old)))
else
    echo '-'
fi

echo "$active $total" > "$tmpfile"

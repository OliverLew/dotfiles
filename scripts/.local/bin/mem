#!/bin/sh

usage()
{
    # TODO: full usage
    echo "Usage: $(basename "$0") [ -S ] [ -B ] [ -bcftu ] [ -123 ]"
    echo ""
    echo
}

# TODO: CAPS for swap?
while getopts "123htufsbcaBST:" arg; do
    case "$arg" in
        t) flag_total=1;;
        u) flag_used=1;;
        f) flag_free=1;;
        b) flag_buff=1;;
        c) flag_cache=1;;
        a) flag_avail=1;;
        B) flag_byte=1;;
        S) flag_swap=1;;
        T) test=$OPTARG;;
        1|2|3) precision=$arg;;
        h|*) usage; exit 0;;
    esac
done

format()
{
    mem="$1"
    if [ -z "$flag_byte" ]; then
        for unit in KB MB GB TB; do
            if [ "$mem" -lt 1024 ]; then
                if [ -n "$decimal" ]; then
                    printf "%d.%s %s\n" "$mem" "$decimal" "$unit"
                else
                    echo "$mem $unit"
                fi
                break
            else
                # TODO: rounding
                decimal=$((mem % 1024 * 1000 / 1024))
                decimal=$(printf "%03d" "$decimal" | cut -c -"${precision:-3}")
                mem=$((mem / 1024))
            fi
        done
    else
        echo "$mem"
    fi
}

info()
{
    result=0
    for keyword in "$@"; do
        temp=$(sed -n "s/^${keyword#-}:[ ]*\([0-9]*\).*/\1/p" /proc/meminfo)
        if [ "$keyword" != "${keyword#-}" ]; then
            result=$((result - temp))
        else
            result=$((result + temp))
        fi
    done
    format "$result"
}

if [ -n "$test" ]; then
    format "$test"
    exit
elif [ "$flag_total" = 1 ]; then
    if [ "$flag_swap" = 1 ]; then
        info SwapTotal
    else
        info MemTotal
    fi
elif [ "$flag_free" = 1 ]; then
    if [ "$flag_swap" = 1 ]; then
        info SwapFree
    else
        info MemFree
    fi
elif [ "$flag_used" = 1 ]; then
    if [ "$flag_swap" = 1 ]; then
        info SwapTotal -SwapFree
    else
        info MemTotal -MemFree -Buffers -Cached -SReclaimable
    fi
elif [ "$flag_buff" = 1 ]; then
    info Buffers
elif [ "$flag_cache" = 1 ]; then
    info Cached SReclaimable
elif [ "$flag_avail" = 1 ]; then
    info MemAvailable
fi
